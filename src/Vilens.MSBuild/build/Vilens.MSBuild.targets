<Project>

  <PropertyGroup>
    <!-- https://learn.microsoft.com/en-us/visualstudio/msbuild/tutorial-custom-task-code-generation?view=visualstudio#changes-required-to-multitarget -->
    <_VilensTasks_NetTaskHost>false</_VilensTasks_NetTaskHost>
    <!--
    NetTaskHost is only supported in MSBuild 18+ when Microsoft.NET.SDK is used
    See: https://github.com/dotnet/msbuild/issues/12723#issuecomment-3493247680
    -->
    <_VilensTasks_NetTaskHost Condition="('$(NETCoreSdkVersion)' != '') AND ('$(NETCoreSdkVersion)' &gt;= '10.0.100') AND ('$(MSBuildVersion)' &gt;= '18.0.0') AND ('$(MSBuildRuntimeType)' == 'Full') AND ('$(UsingMicrosoftNETSdk)' == 'true')">true</_VilensTasks_NetTaskHost>
    <_VilensTasks_TFM Condition=" '$(MSBuildRuntimeType)' == 'Full' ">net472</_VilensTasks_TFM>
    <_VilensTasks_TFM Condition=" ('$(MSBuildRuntimeType)' == 'Core') OR $(_VilensTasks_NetTaskHost) ">net8.0</_VilensTasks_TFM>
    <VilensTasksBasePath Condition=" '$(VilensTasksBasePath)' == '' ">$(MSBuildThisFileDirectory)..\tasks\</VilensTasksBasePath>
    <VilensTaskPath Condition=" '$(VilensTaskPath)' == '' ">$(VilensTasksBasePath)\$(_VilensTasks_TFM)\Vilens.MSBuild.dll</VilensTaskPath>
    <VilensTaskPath>$([System.IO.Path]::GetFullPath('$(VilensTaskPath)'))</VilensTaskPath>
  </PropertyGroup>

  <!--
  Use this only when in VS18 or later
  VS18 can run the .NET MSBuild tasks even when running under .NET Framework MSBuild by running it in a separate process.
  See: https://aka.ms/nettaskhost
  -->
  <UsingTask TaskName="Vilens.MSBuild.Scramble"
             Condition="$(_VilensTasks_NetTaskHost)"
             Runtime="NET"
             TaskFactory="TaskHostFactory"
             AssemblyFile="$(VilensTaskPath)" />

  <!-- Use this when in VS17 and earlier OR dotnet cli -->
  <UsingTask TaskName="Vilens.MSBuild.Scramble"
             Condition="!$(_VilensTasks_NetTaskHost)"
             AssemblyFile="$(VilensTaskPath)" />

  <Target Name="CommitVilens"
          AfterTargets="CoreCompile"
          Inputs="@(IntermediateAssembly)"
          Outputs="@(IntermediateAssembly->'%(FullPath).vilens.done')"
          Condition="'$(DesignTimeBuild)' != 'true'">

    <Message Text="Loaded task from '$(VilensTaskPath)'" />

    <Delete Files="@(IntermediateAssembly->'%(FullPath).vilens.log')" />

    <PropertyGroup>
      <VilensScope Condition="'$(VilensScope)' == ''">Auto</VilensScope>
      <VilensFeatures Condition="'$(VilensFeatures)' == ''">None</VilensFeatures>
      <_VilensAotSafeMode>false</_VilensAotSafeMode>
      <_VilensAotSafeMode Condition="('$(IsAotCompatible)' == 'true') OR ('$(PublishAot)' == 'true')">true</_VilensAotSafeMode>
    </PropertyGroup>

    <PropertyGroup Condition="'$(AssemblyOriginatorKeyFile)' != '' AND '$(SignAssembly)' == 'True'">
      <_StrongNamingKey>$(AssemblyOriginatorKeyFile)</_StrongNamingKey>
    </PropertyGroup>

    <ItemGroup>
      <_VilensPdbFile Include="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).pdb')"
                      Condition="Exists('@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).pdb')')" />
    </ItemGroup>

    <Error Text="'VilensTaskPath' is not set."
           Condition="'$(VilensTaskPath)' == ''" />
    <Error Text="'$(VilensTaskPath)' does not exist."
           Condition="!Exists('$(VilensTaskPath)')" />
    <Copy SourceFiles="@(IntermediateAssembly)"
          Condition="'$(VilensBackup)' != 'false'"
          DestinationFiles="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).unobfuscated%(Extension)')" />
    <Copy SourceFiles="@(_VilensPdbFile)"
          Condition="'$(VilensBackup)' != 'false'"
          DestinationFiles="@(_VilensPdbFile->'%(RootDir)%(Directory)%(Filename).unobfuscated.pdb')" />
    <Vilens.MSBuild.Scramble Features="$(VilensFeatures)"
                             Scope="$(VilensScope)"
                             Assembly="@(IntermediateAssembly)"
                             PdbFile="@(_VilensPdbFile)"
                             StrongNamingKey="$(_StrongNamingKey)"
                             AotSafeMode="$(_VilensAotSafeMode)"
                             LogFile="@(IntermediateAssembly->'%(FullPath).vilens.log')"
                             DelaySign="$(DelaySign)" />

    <Error Text="Vilens failed. See @(IntermediateAssembly->'%(FullPath).vilens.log') for details."
           Condition="!Exists(@(IntermediateAssembly->'%(FullPath).vilens.done'))" />

  </Target>

  <Target Name="CleanVilens"
          AfterTargets="CoreClean">
    <Delete Files="@(IntermediateAssembly->'%(FullPath).vilens.log')" />
    <Delete Files="@(IntermediateAssembly->'%(FullPath).vilens.done')" />
    <Delete Files="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).unobfuscated%(Extension)')" />
    <Delete Files="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).unobfuscated.pdb')" />
  </Target>

</Project>