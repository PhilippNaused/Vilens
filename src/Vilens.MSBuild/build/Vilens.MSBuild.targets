<Project>

  <PropertyGroup>
    <!-- https://learn.microsoft.com/en-us/visualstudio/msbuild/tutorial-custom-task-code-generation?view=visualstudio#changes-required-to-multitarget -->
    <VilensTasks_TFM Condition=" '$(MSBuildRuntimeType)' == 'Full' ">net472</VilensTasks_TFM>
    <VilensTasks_TFM Condition=" '$(MSBuildRuntimeType)' == 'Core' ">net8.0</VilensTasks_TFM>
    <VilensTasksPath Condition=" '$(VilensTasksPath)' == '' ">$(MSBuildThisFileDirectory)..\tasks\$(VilensTasks_TFM)\Vilens.MSBuild.dll</VilensTasksPath>
  </PropertyGroup>

  <UsingTask TaskName="Vilens.MSBuild.Scramble"
             AssemblyFile="$(VilensTasksPath)" />

  <Target Name="CommitVilens"
          AfterTargets="CoreCompile"
          Inputs="@(IntermediateAssembly)"
          Outputs="@(IntermediateAssembly->'%(FullPath).vilens.done')"
          Condition="'$(DesignTimeBuild)' != 'true'">

    <Delete Files="@(IntermediateAssembly->'%(FullPath).vilens.log')" />

    <PropertyGroup>
      <VilensScope Condition="'$(VilensScope)' == ''">Auto</VilensScope>
      <_VilensFeatures>@(VilensFeatures, ',')</_VilensFeatures>
      <_VilensFeatures Condition="'$(_VilensFeatures)' == ''">None</_VilensFeatures>
    </PropertyGroup>

    <PropertyGroup Condition="'$(AssemblyOriginatorKeyFile)' != '' AND '$(SignAssembly)' == 'True'">
      <_StrongNamingKey>$(AssemblyOriginatorKeyFile)</_StrongNamingKey>
    </PropertyGroup>

    <ItemGroup>
      <_VilensPdbFile Include="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).pdb')"
                      Condition="Exists('@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).pdb')')" />
    </ItemGroup>

    <Error Text="'VilensTasksPath' is not set."
           Condition="'$(VilensTasksPath)' == ''" />
    <Error Text="'$(VilensTasksPath)' does not exist."
           Condition="!Exists('$(VilensTasksPath)')" />
    <Copy SourceFiles="@(IntermediateAssembly)"
          Condition="'$(VilensBackup)' != 'false'"
          DestinationFiles="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).unobfuscated%(Extension)')" />
    <Copy SourceFiles="@(_VilensPdbFile)"
          Condition="'$(VilensBackup)' != 'false'"
          DestinationFiles="@(_VilensPdbFile->'%(RootDir)%(Directory)%(Filename).unobfuscated.pdb')" />
    <Vilens.MSBuild.Scramble Features="$(_VilensFeatures)"
                             Scope="$(VilensScope)"
                             Assembly="@(IntermediateAssembly)"
                             PdbFile="@(_VilensPdbFile)"
                             StrongNamingKey="$(_StrongNamingKey)"
                             LogFile="@(IntermediateAssembly->'%(FullPath).vilens.log')"
                             DelaySign="$(DelaySign)" />

    <Error Text="Vilens failed. See @(IntermediateAssembly->'%(FullPath).vilens.log') for details."
           Condition="!Exists(@(IntermediateAssembly->'%(FullPath).vilens.done'))" />

  </Target>

  <Target Name="CleanVilens"
          AfterTargets="CoreClean">
    <Delete Files="@(IntermediateAssembly->'%(FullPath).vilens.log')" />
    <Delete Files="@(IntermediateAssembly->'%(FullPath).vilens.done')" />
    <Delete Files="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).unobfuscated%(Extension)')" />
    <Delete Files="@(IntermediateAssembly->'%(RootDir)%(Directory)%(Filename).unobfuscated.pdb')" />
  </Target>

</Project>