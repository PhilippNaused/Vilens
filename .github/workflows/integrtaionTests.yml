name: Integration Test

on:
  workflow_dispatch:
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - windows-latest
        - windows-11-arm
        repo:
        - Autofac
        - Bshox
        - Serilog
        # - Moq # TODO: fix on linux
        # - NUnit # TODO: fix on linux
        include:
        - os: "windows-latest"
          repo: "Moq"
        - os: "windows-latest"
          repo: "NUnit"
    runs-on: ${{ matrix.os }}

    name: Testing ${{ matrix.repo }} on ${{ matrix.os }}

    steps:
    - name: ‚§µÔ∏è Checkout Source
      uses: actions/checkout@v6

    - name: ‚§µÔ∏è Checkout ${{ matrix.repo }} Submodule
      run: git submodule update --init --recursive Tests/Integration/${{ matrix.repo }}

    - name: üõ†Ô∏è Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: global.json
        dotnet-version: |
          8.0.x
          9.0.x

    # cspell:ignore devel
    - name: üõ†Ô∏è Install mono
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -y mono-devel

    - name: üõ†Ô∏è Restore dependencies
      run: dotnet restore src/Vilens.MSBuild

    - name: üß™ Test
      shell: pwsh
      run: ./IntegrationTests.ps1 ${{ matrix.repo }}
