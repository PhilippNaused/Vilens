name: Integration Test

on:
  workflow_dispatch:
  pull_request:
    branches: [main]

jobs:
  build:
  # TODO: https://docs.github.com/en/actions/how-tos/write-workflows/choose-what-workflows-do/run-job-variations
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - windows-latest
        repo:
        - Autofac
        - Bshox
        # - Moq # TODO: fix on linux
        # - NUnit # TODO: fix on linux
        # - Serilog # TODO: fix
    runs-on: ${{ matrix.os }}

    name: Testing ${{ matrix.repo }} on ${{ matrix.os }}

    steps:
    - name: â¤µï¸ Checkout Source
      uses: actions/checkout@v5

    - name: â¤µï¸ Checkout ${{ matrix.repo }} Submodule
      run: git submodule update --init --recursive Tests/Integration/${{ matrix.repo }}

    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: global.json
        dotnet-version: |
          8.0.x
          9.0.x

    # cspell:ignore devel
    - name: ğŸ› ï¸ Install mono and nuget
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Workaround for https://github.com/actions/runner-images/issues/10631
        sudo sh -c 'echo "deb http://archive.ubuntu.com/ubuntu jammy main universe" > /etc/apt/sources.list.d/jammy.list'
        sudo apt-get update
        sudo apt-get install -y mono-devel
        sudo apt-get install -y nuget

    - name: ğŸ› ï¸ Restore dependencies
      run: dotnet restore src/Vilens.MSBuild

    - name: ğŸ§ª Test
      shell: pwsh
      run: ./IntegrationTests.ps1 ${{ matrix.repo }}
