name: Integration Test

on:
  workflow_dispatch:
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - windows-latest
        repo:
        - Autofac
        - Bshox
        - Serilog
        # - Moq # TODO: fix on linux
        # - NUnit # TODO: fix on linux
        include:
        - os: "windows-latest"
          repo: "Moq"
        - os: "windows-latest"
          repo: "NUnit"
        # Bshox is the most stable test repo (because I wrote it), so its the one we test on all platforms (e.g. ARM)
        - os: "windows-11-arm"
          repo: "Bshox"
        - os: "ubuntu-24.04-arm"
          repo: "Bshox"
        - os: "macos-latest"
          repo: "Bshox"
    runs-on: ${{ matrix.os }}

    name: Testing ${{ matrix.repo }} on ${{ matrix.os }}

    steps:
    - name: â¤µï¸ Checkout Source
      uses: actions/checkout@v6

    - name: â¤µï¸ Checkout ${{ matrix.repo }} Submodule
      run: git submodule update --init --recursive Tests/Integration/${{ matrix.repo }}

    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: global.json
        dotnet-version: |
          8.0.x
          9.0.x

    # cspell:ignore devel
    - name: ğŸ› ï¸ Install mono (ğŸ§)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y mono-devel

    - name: ğŸ› ï¸ Install mono (ğŸ)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install mono

    - name: ğŸ› ï¸ Restore dependencies
      run: dotnet restore src/Vilens.MSBuild

    - name: ğŸ§ª Test
      shell: pwsh
      run: ./IntegrationTests.ps1 ${{ matrix.repo }}
